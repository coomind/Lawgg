<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAW.GG ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .section { margin-bottom: 40px; }
        .section h2 { color: #333; border-left: 4px solid #007cba; padding-left: 10px; }
        .item { background: #f9f9f9; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #ff6b6b; }
        .item.low-priority { border-left-color: #ffa726; }
        .item.high-priority { border-left-color: #f44336; }
        .item-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .item-title { font-weight: bold; flex: 1; }
        .item-meta { font-size: 12px; color: #666; margin-bottom: 8px; }
        .item-content { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; max-height: 100px; overflow-y: auto; }
        .buttons { display: flex; gap: 10px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-info { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn:hover { opacity: 0.8; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat { background: #e3f2fd; padding: 15px; border-radius: 5px; text-align: center; }
        .blocked-ip { background: #ffebee; border-left-color: #9c27b0; }
        .logout { background: #757575; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; }
        .logout:hover { background: #616161; }
        .manual-ban { background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .manual-ban input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ LAW.GG ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <a href="/admin/logout" class="logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>

        <div class="stats">
            <div class="stat">
                <div style="font-size: 24px; font-weight: bold; color: #f44336;">{{ reported_proposals|length }}</div>
                <div>ì‹ ê³ ëœ ì…ë²•ì œì•ˆ</div>
            </div>
            <div class="stat">
                <div style="font-size: 24px; font-weight: bold; color: #ff9800;">{{ reported_comments|length }}</div>
                <div>ì‹ ê³ ëœ ëŒ“ê¸€</div>
            </div>
            <div class="stat">
                <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">{{ blocked_ips|length }}</div>
                <div>ì°¨ë‹¨ëœ IP</div>
            </div>
        </div>

        <!-- ìˆ˜ë™ IP ì°¨ë‹¨ -->
        <div class="section">
            <h2>ğŸš« ìˆ˜ë™ IP ì°¨ë‹¨</h2>
            <div class="manual-ban">
                <input type="text" id="manual-ip" placeholder="ì°¨ë‹¨í•  IP ì£¼ì†Œ ì…ë ¥" style="width: 200px;">
                <input type="text" id="manual-reason" placeholder="ì°¨ë‹¨ ì‚¬ìœ " style="width: 300px;">
                <button class="btn btn-danger" onclick="manualBanIP()">IP ì°¨ë‹¨</button>
            </div>
        </div>

        <!-- ì‹ ê³ ëœ ì…ë²•ì œì•ˆ -->
        <div class="section">
            <h2>ğŸ“‹ ì‹ ê³ ëœ ì…ë²•ì œì•ˆ ({{ reported_proposals|length }}ê°œ)</h2>
            {% for proposal in reported_proposals %}
            <div class="item {% if proposal.report_count >= 5 %}high-priority{% elif proposal.report_count >= 3 %}{% else %}low-priority{% endif %}" data-proposal-id="{{ proposal.id }}">
                <div class="item-header">
                    <div class="item-title">{{ proposal.title }}</div>
                    <div style="background: #f44336; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                        ì‹ ê³  {{ proposal.report_count }}íšŒ
                    </div>
                </div>
                <div class="item-meta">
                    ID: {{ proposal.id }} | ì‘ì„±ì¼: {{ proposal.created_date }} | ì¡°íšŒìˆ˜: {{ proposal.view_count }}
                </div>
                <div class="item-content">{{ proposal.current_situation[:200] }}...</div>
                <div class="buttons">
                    <button class="btn btn-danger" onclick="deleteProposal({{ proposal.id }})">ğŸ—‘ï¸ ì‚­ì œ</button>
                    <button class="btn btn-warning" onclick="banProposalAuthor({{ proposal.id }})">ğŸš« ì‘ì„±ì IP ì°¨ë‹¨</button>
                    <button class="btn btn-info" onclick="window.open('/proposals/{{ proposal.id }}', '_blank')">ğŸ‘ï¸ ë³´ê¸°</button>
                </div>
            </div>
            {% endfor %}
            {% if not reported_proposals %}
            <div style="text-align: center; color: #666; padding: 20px;">ì‹ ê³ ëœ ì…ë²•ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
        </div>

        <!-- ì‹ ê³ ëœ ëŒ“ê¸€ -->
        <div class="section">
            <h2>ğŸ’¬ ì‹ ê³ ëœ ëŒ“ê¸€/ë‹µê¸€ ({{ reported_comments|length }}ê°œ)</h2>
            {% for comment in reported_comments %}
            <div class="item {% if comment.report_count >= 5 %}high-priority{% elif comment.report_count >= 3 %}{% else %}low-priority{% endif %}" data-comment-id="{{ comment.id }}">
                <div class="item-header">
                    <div class="item-title">
                        {{ comment.author or 'ìµëª…' + comment.id|string }} 
                        {% if comment.parent_id %}(ë‹µê¸€){% endif %}
                        - {{ 'ì°¬ì„±' if comment.stance == 'agree' else 'ë°˜ëŒ€' }}
                    </div>
                    <div style="background: #f44336; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                        ì‹ ê³  {{ comment.report_count }}íšŒ
                    </div>
                </div>
                <div class="item-meta">
                    ID: {{ comment.id }} | 
                    {% if comment.bill_id %}ë²•ë¥ ì•ˆ{% else %}ì…ë²•ì œì•ˆ{% endif %} | 
                    {% if comment.parent_id %}ë‹µê¸€{% else %}ëŒ“ê¸€{% endif %}
                </div>
                <div class="item-content">{{ comment.content }}</div>
                <div class="buttons">
                    <button class="btn btn-danger" onclick="deleteComment({{ comment.id }})">ğŸ—‘ï¸ ì‚­ì œ</button>
                    <button class="btn btn-warning" onclick="banCommentAuthor({{ comment.id }})">ğŸš« ì‘ì„±ì IP ì°¨ë‹¨</button>
                    {% if comment.bill_id %}
                    <button class="btn btn-info" onclick="window.open('/bills/{{ comment.bill_id }}', '_blank')">ğŸ‘ï¸ ì›ê¸€ ë³´ê¸°</button>
                    {% else %}
                    <button class="btn btn-info" onclick="window.open('/proposals/{{ comment.proposal_id }}', '_blank')">ğŸ‘ï¸ ì›ê¸€ ë³´ê¸°</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% if not reported_comments %}
            <div style="text-align: center; color: #666; padding: 20px;">ì‹ ê³ ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
        </div>

        <!-- ì°¨ë‹¨ëœ IP -->
        <div class="section">
            <h2>ğŸš« ì°¨ë‹¨ëœ IP ëª©ë¡ ({{ blocked_ips|length }}ê°œ)</h2>
            {% for blocked in blocked_ips %}
            <div class="item blocked-ip" data-blocked-id="{{ blocked.id }}">
                <div class="item-header">
                    <div class="item-title">{{ blocked.ip_address }}</div>
                    <div style="background: #9c27b0; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                        ì°¨ë‹¨ë¨
                    </div>
                </div>
                <div class="item-meta">ì°¨ë‹¨ì¼: {{ blocked.blocked_at.strftime('%Y-%m-%d %H:%M') }}</div>
                <div class="item-content">ì‚¬ìœ : {{ blocked.reason }}</div>
                <div class="buttons">
                    <button class="btn btn-success" onclick="unbanIP({{ blocked.id }})">âœ… ì°¨ë‹¨ í•´ì œ</button>
                </div>
            </div>
            {% endfor %}
            {% if not blocked_ips %}
            <div style="text-align: center; color: #666; padding: 20px;">ì°¨ë‹¨ëœ IPê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}
        </div>
    </div>

    <script>
        // ì„±ê³µ/ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, type = 'info') {
            const existingMessage = document.querySelector('.admin-message');
            if (existingMessage) existingMessage.remove();
            
            const messageEl = document.createElement('div');
            messageEl.className = 'admin-message';
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 6px;
                color: white; font-weight: bold; z-index: 1000;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
            `;
            document.body.appendChild(messageEl);
            setTimeout(() => messageEl.remove(), 3000);
        }

        // ì…ë²•ì œì•ˆ ì‚­ì œ
        async function deleteProposal(proposalId) {
            if (!confirm('ì •ë§ë¡œ ì´ ì…ë²•ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê´€ë ¨ ëŒ“ê¸€ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) return;
            
            try {
                const response = await fetch(`/admin/proposals/${proposalId}/delete`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.querySelector(`[data-proposal-id="${proposalId}"]`).remove();
                } else {
                    showMessage(data.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ
        async function deleteComment(commentId) {
            if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë‹µê¸€ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;
            
            try {
                const response = await fetch(`/admin/comments/${commentId}/delete`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.querySelector(`[data-comment-id="${commentId}"]`).remove();
                } else {
                    showMessage(data.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
            }
        }

        // ì…ë²•ì œì•ˆ ì‘ì„±ì IP ì°¨ë‹¨
        async function banProposalAuthor(proposalId) {
            if (!confirm('ì´ ì…ë²•ì œì•ˆ ì‘ì„±ìì˜ IPë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/admin/proposals/${proposalId}/ban-author`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error || 'IP ì°¨ë‹¨ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
            }
        }

        // ëŒ“ê¸€ ì‘ì„±ì IP ì°¨ë‹¨
        async function banCommentAuthor(commentId) {
            if (!confirm('ì´ ëŒ“ê¸€ ì‘ì„±ìì˜ IPë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/admin/comments/${commentId}/ban-author`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error || 'IP ì°¨ë‹¨ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
            }
        }

        // ìˆ˜ë™ IP ì°¨ë‹¨
        async function manualBanIP() {
            const ip = document.getElementById('manual-ip').value.trim();
            const reason = document.getElementById('manual-reason').value.trim() || 'ê´€ë¦¬ìì— ì˜í•œ ìˆ˜ë™ ì°¨ë‹¨';
            
            if (!ip) {
                showMessage('IP ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/ban-ip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip_address: ip, reason: reason })
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.getElementById('manual-ip').value = '';
                    document.getElementById('manual-reason').value = '';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(data.error || 'IP ì°¨ë‹¨ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
            }
        }

        // IP ì°¨ë‹¨ í•´ì œ
        async function unbanIP(blockedId) {
            if (!confirm('ì´ IPì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/admin/unban-ip/${blockedId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.querySelector(`[data-blocked-id="${blockedId}"]`).remove();
                } else {
                    showMessage(data.error || 'ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
            }
        }

        // ì—”í„°í‚¤ë¡œ IP ì°¨ë‹¨
        document.getElementById('manual-reason').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') manualBanIP();
        });
    </script>
</body>
</html>
